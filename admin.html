<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Portfolio</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        :root {
            --bg-color: #000000;
            --bg-secondary: #111111;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #ffffff;
        }

        .admin-container {
            padding-top: 120px;
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        .form-group {
            margin-bottom: 2rem;
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        h3 {
            margin-bottom: 1.5rem;
            font-family: var(--font-heading);
            font-size: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        input,
        textarea {
            width: 100%;
            padding: 0.8rem;
            background: var(--bg-color);
            border: 1px solid #333;
            color: white;
            border-radius: 6px;
            font-family: inherit;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .login-box {
            max-width: 400px;
            margin: 15vh auto;
            padding: 2rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        .upload-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 0.5rem;
        }

        .status-msg {
            font-size: 0.8rem;
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .status-success {
            display: block;
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
        }

        .status-error {
            display: block;
            background: rgba(255, 0, 0, 0.1);
            color: #ff0000;
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-box">
        <h2 class="section-title">Admin Login<span class="accent">.</span></h2>
        <div style="margin-top: 2rem;">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required style="margin-top: 1rem;">
            <button id="login-btn" class="btn btn-primary" style="margin-top: 2rem; width: 100%;">Login</button>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="admin-container hidden">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; padding: 0 1rem;">
            <h1 class="headline" style="font-size: 2.5rem;">Dashboard</h1>
            <button id="logout-btn" class="btn btn-outline" style="padding: 8px 20px;">Logout</button>
        </div>

        <div class="container">
            <!-- Site Settings -->
            <section class="form-group">
                <h3>Site Settings</h3>
                <label>Active Theme</label>
                <select id="site-theme"
                    style="width: 100%; padding: 0.8rem; background: var(--bg-color); border: 1px solid #333; color: white; border-radius: 6px;">
                    <option value="default">Default (Dark Gold)</option>
                    <option value="light">Light (Clean Blue)</option>
                    <option value="midnight">Midnight (Deep Purple)</option>
                    <option value="nature">Nature (Forest Green)</option>
                    <option value="monochrome">Monochrome (Black & White)</option>
                </select>
                <button onclick="updateTheme()" class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;">Save
                    Theme</button>
            </section>

            <!-- Hero Section -->
            <section class="form-group">
                <h3>Hero Section</h3>
                <label>Full Name</label>
                <input type="text" id="hero-name" placeholder="MD Zeehan Siddique">
                <label>Sub-title</label>
                <input type="text" id="hero-subtitle" placeholder="Mechanical Engineer & CAD Designer">
                <label>Description</label>
                <textarea id="hero-desc" rows="3"></textarea>
                <label>Profile Picture</label>
                <input type="file" id="hero-image-file" accept="image/*">
                <button id="save-hero-btn" onclick="updateHero()" class="btn btn-primary"
                    style="margin-top: 1.5rem; width: 100%;">Save Hero</button>
            </section>

            <!-- Education -->
            <section class="form-group">
                <h3>Education</h3>
                <p style="font-size: 0.8rem; color: #888; margin-bottom: 1rem;">Format: Date | Degree | Institution |
                    GPA</p>
                <textarea id="edu-content" rows="4"></textarea>
                <button onclick="updateSection('education', 'edu-content')" class="btn btn-primary"
                    style="margin-top: 1rem; width: 100%;">Save Education</button>
            </section>

            <!-- Experience -->
            <section class="form-group">
                <h3>Experience</h3>
                <p style="font-size: 0.8rem; color: #888; margin-bottom: 1rem;">Format: Date | Role | Company | Point 1;
                    Point 2</p>
                <textarea id="exp-content" rows="4"></textarea>
                <button onclick="updateSection('experience', 'exp-content')" class="btn btn-primary"
                    style="margin-top: 1rem; width: 100%;">Save Experience</button>
            </section>

            <!-- Leadership -->
            <section class="form-group">
                <h3>Leadership & Activities</h3>
                <p style="font-size: 0.8rem; color: #888; margin-bottom: 1rem;">Format: Role | Organization |
                    Description</p>
                <textarea id="act-content" rows="4"></textarea>
                <button onclick="updateSection('activities', 'act-content')" class="btn btn-primary"
                    style="margin-top: 1rem; width: 100%;">Save Activities</button>
            </section>

            <!-- Skills & Awards -->
            <section class="form-group">
                <h3>Skills & Awards</h3>
                <label>Technical Skills (Comma separated)</label>
                <input type="text" id="skills-list">

                <label>Awards & Certificates (One per line)</label>
                <p style="font-size: 0.8rem; color: #888; margin-bottom: 0.5rem;">Format: Name {url}</p>
                <textarea id="awards-list" rows="5"></textarea>

                <label>Upload New Certificate</label>
                <div class="upload-row">
                    <input type="file" id="cert-upload-file" accept="image/*">
                    <button id="cert-upload-btn" onclick="uploadCertificate()" class="btn btn-outline"
                        style="padding: 10px 20px; white-space: nowrap;">Upload</button>
                </div>
                <div id="cert-status" class="status-msg"></div>

                <button onclick="updateSkillsAwards()" class="btn btn-primary"
                    style="margin-top: 2rem; width: 100%;">Save Skills & Awards</button>
            </section>

            <!-- Contact -->
            <section class="form-group">
                <h3>Contact Information</h3>
                <label>Phone Number</label>
                <input type="text" id="contact-phone">
                <label>Email Address</label>
                <input type="text" id="contact-email">
                <label>LinkedIn URL</label>
                <input type="text" id="contact-linkedin">
                <button onclick="updateContact()" class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;">Save
                    Contact Info</button>
            </section>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://odklzxloviqmmldmrmes.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ka2x6eGxvdmlxbW1sZG1ybWVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NzIyODMsImV4cCI6MjA4NjA0ODI4M30.vJdUyT3_IrVrhne4_zndwuE2npj9VRewWgGT4JJ5DzY';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');

        // Initial Session Check
        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                showAdmin();
            }
        }

        function showAdmin() {
            loginScreen.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            loadAllContent();
        }

        async function loadAllContent() {
            try {
                const { data: allContent, error } = await supabaseClient.from('portfolio_content').select('*');
                if (error) throw error;

                allContent.forEach(item => {
                    const content = typeof item.content === 'string' ? JSON.parse(item.content) : item.content;

                    if (item.section_name === 'hero') {
                        document.getElementById('hero-name').value = content.name || '';
                        document.getElementById('hero-subtitle').value = content.subtitle || '';
                        document.getElementById('hero-desc').value = content.description || '';
                    } else if (item.section_name === 'education') {
                        document.getElementById('edu-content').value = content.raw || '';
                    } else if (item.section_name === 'experience') {
                        document.getElementById('exp-content').value = content.raw || '';
                    } else if (item.section_name === 'activities') {
                        document.getElementById('act-content').value = content.raw || '';
                    } else if (item.section_name === 'skills_awards') {
                        document.getElementById('skills-list').value = content.skills || '';
                        document.getElementById('awards-list').value = content.awards || '';
                    } else if (item.section_name === 'contact') {
                        document.getElementById('contact-phone').value = content.phone || '';
                        document.getElementById('contact-email').value = content.email || '';
                        document.getElementById('contact-linkedin').value = content.linkedin || '';
                    } else if (item.section_name === 'settings') {
                        document.getElementById('site-theme').value = content.theme || 'default';
                        document.documentElement.setAttribute('data-theme', content.theme || 'default');
                    }
                });
            } catch (err) {
                console.error("Error loading content:", err);
            }
        }

        // Generic Section Update
        async function updateSection(name, fieldId) {
            const raw = document.getElementById(fieldId).value;
            const btn = event.target;
            btn.disabled = true;
            btn.innerText = 'Saving...';

            const { error } = await supabaseClient
                .from('portfolio_content')
                .upsert({ section_name: name, content: { raw } }, { onConflict: 'section_name' });

            btn.disabled = false;
            btn.innerText = `Save ${name.charAt(0).toUpperCase() + name.slice(1)}`;

            if (error) alert("Error: " + error.message);
            else alert("Saved successfully!");
        }

        async function updateSkillsAwards() {
            const skills = document.getElementById('skills-list').value;
            const awards = document.getElementById('awards-list').value;
            const btn = event.target;
            btn.disabled = true;

            const { error } = await supabaseClient
                .from('portfolio_content')
                .upsert({ section_name: 'skills_awards', content: { skills, awards } }, { onConflict: 'section_name' });

            btn.disabled = false;
            if (error) alert("Error: " + error.message);
            else alert("Skills & Awards saved!");
        }

        async function updateContact() {
            const phone = document.getElementById('contact-phone').value;
            const email = document.getElementById('contact-email').value;
            const linkedin = document.getElementById('contact-linkedin').value;
            const btn = event.target;
            btn.disabled = true;

            const { error } = await supabaseClient
                .from('portfolio_content')
                .upsert({ section_name: 'contact', content: { phone, email, linkedin } }, { onConflict: 'section_name' });

            btn.disabled = false;
            if (error) alert("Error: " + error.message);
            else alert("Contact Info saved!");
        }

        async function updateTheme() {
            const theme = document.getElementById('site-theme').value;
            const btn = event.target;
            btn.disabled = true;
            btn.innerText = 'Saving...';

            const { error } = await supabaseClient
                .from('portfolio_content')
                .upsert({ section_name: 'settings', content: { theme } }, { onConflict: 'section_name' });

            btn.disabled = false;
            btn.innerText = 'Save Theme';

            if (error) {
                alert("Error: " + error.message);
            } else {
                document.documentElement.setAttribute('data-theme', theme);
                alert("Theme updated successfully!");
            }
        }

        async function updateHero() {
            const btn = document.getElementById('save-hero-btn');
            const file = document.getElementById('hero-image-file').files[0];
            const name = document.getElementById('hero-name').value;
            const subtitle = document.getElementById('hero-subtitle').value;
            const description = document.getElementById('hero-desc').value;

            btn.disabled = true;
            btn.innerText = 'Saving...';

            try {
                let profileUrl = null;
                if (file) {
                    const fileName = `profile-${Date.now()}`;
                    const { data, error } = await supabaseClient.storage.from('project-images').upload(fileName, file);
                    if (error) throw error;
                    const { data: { publicUrl } } = supabaseClient.storage.from('project-images').getPublicUrl(fileName);
                    profileUrl = publicUrl;
                }

                // Get existing content to preserve profile_url if not changed
                const { data: current } = await supabaseClient.from('portfolio_content').select('content').eq('section_name', 'hero').single();
                const existing = current ? (typeof current.content === 'string' ? JSON.parse(current.content) : current.content) : {};

                const { error } = await supabaseClient.from('portfolio_content').upsert({
                    section_name: 'hero',
                    content: {
                        name,
                        subtitle,
                        description,
                        profile_url: profileUrl || existing.profile_url
                    }
                }, { onConflict: 'section_name' });

                if (error) throw error;
                alert("Hero section updated!");
                location.reload();
            } catch (err) {
                alert("Error: " + err.message);
                btn.disabled = false;
                btn.innerText = 'Save Hero';
            }
        }

        async function uploadCertificate() {
            const fileInput = document.getElementById('cert-upload-file');
            const file = fileInput.files[0];
            const status = document.getElementById('cert-status');
            const btn = document.getElementById('cert-upload-btn');

            if (!file) {
                alert("Please select a file first.");
                return;
            }

            btn.disabled = true;
            status.innerHTML = "Uploading certificate...";
            status.className = "status-msg status-success";

            try {
                const fileName = `certs/${Date.now()}-${file.name.replace(/\s/g, '_')}`;
                const { data, error } = await supabaseClient.storage.from('project-images').upload(fileName, file);
                if (error) throw error;

                const { data: { publicUrl } } = supabaseClient.storage.from('project-images').getPublicUrl(fileName);

                status.innerHTML = `Success! Link created. Copying to awards list...`;

                const awardsList = document.getElementById('awards-list');
                const cleanName = file.name.split('.')[0].replace(/[-_]/g, ' ');
                if (awardsList.value && !awardsList.value.endsWith('\n')) awardsList.value += '\n';
                awardsList.value += `${cleanName} {${publicUrl}}`;

                fileInput.value = '';
                setTimeout(() => { status.style.display = 'none'; }, 5000);
            } catch (err) {
                status.innerHTML = "Upload failed: " + err.message;
                status.className = "status-msg status-error";
            } finally {
                btn.disabled = false;
            }
        }

        // Auth Actions
        document.getElementById('login-btn').onclick = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) alert(error.message);
            else showAdmin();
        };

        document.getElementById('logout-btn').onclick = async () => {
            await supabaseClient.auth.signOut();
            window.location.reload();
        };

        init();
    </script>
</body>

</html>